#!/bin/bash

# Check if root
if [ $(id -u) -ne 0 ]; then
    echo "Script must be run as root"
    exit 1
fi

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
    echo "Homebrew not found, installing..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
    echo "Homebrew already installed"
fi

# Check if package lists have been updated in the last 48 hours
if [ ! -e /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula/openssl.rb ] || [ $(find /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula/openssl.rb -mtime +1) ]; then
    echo "Updating package lists..."
    brew update
else
    echo "Package lists already up to date"
fi

# Install required packages if not already installed
required_packages=(rkhunter clamav lynis chkrootkit)
for package in "${required_packages[@]}"; do
    if ! command -v "$package" &> /dev/null; then
        echo "$package not found, installing..."
        brew install "$package"
    else
        echo "$package already installed"
    fi
done

# Run system scans and save output to a file
echo "Running system scans..."
sudo rkhunter --update
sudo rkhunter --propupd
sudo rkhunter --check >> ~/system_scan.txt
sudo clamscan -r / >> ~/system_scan.txt
sudo lynis audit system >> ~/system_scan.txt
sudo chkrootkit >> ~/system_scan.txt

echo "System scans completed. Results saved to ~/system_scan.txt"
