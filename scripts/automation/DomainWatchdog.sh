#!/bin/bash

# Check if the correct number of arguments are provided
if [ "$#" -ne 2 ]; then
    echo "Usage: $0 domain output_file"
    exit 1
fi

# Assign the arguments to variables
domain=$1
output_file=$2

# Define the wordlist file
wordlist="directory-list-2.3-medium.txt"

# Check if dig, ffuf, and wget are installed
for tool in dig ffuf wget; do
    if ! command -v $tool &> /dev/null; then
        echo "$tool is required but not installed. Please install it first."
        exit 1
    fi
done

# Check if the wordlist file exists
if [ ! -f $wordlist ]; then
    # If the wordlist file does not exist, download it from the SecLists GitHub repository
    echo "Downloading wordlist..."
    wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/$wordlist
fi

# Fetch the current DNS records of the domain
current_dns_records=$(dig $domain ANY +noall +answer)

# Check if the output file exists
if [ ! -f $output_file ]; then
    # If the output file does not exist, create it and write the current DNS records to it
    echo "$current_dns_records" > $output_file
else
    # If the output file exists, read the previous DNS records from it
    previous_dns_records=$(cat $output_file)

    # Compare the current DNS records with the previous ones
    if [ "$current_dns_records" != "$previous_dns_records" ]; then
        # If the DNS records have changed, log the changes and send an alert
        echo "DNS records for $domain have changed:"
        echo "Previous DNS records:"
        echo "$previous_dns_records"
        echo "Current DNS records:"
        echo "$current_dns_records"

        # Update the output file with the current DNS records
        echo "$current_dns_records" > $output_file
    fi
fi

# Run ffuf to fuzz the directories of the domain
echo "Running directory fuzzing on $domain..."
ffuf -w $wordlist -u http://$domain/FUZZ -mc 200,204,301,302,307,401,403 -o new_directories.json -of json

# Check if any new directories were found
new_directories=$(jq -r '.results[] | .url' new_directories.json)

if [ -n "$new_directories" ]; then
    # If new directories were found, log them and send an alert
    echo "New directories found on $domain:"
    echo "$new_directories"
fi
