#!/usr/bin/env python3

"""
This script chains together popular fuzzing and enumeration tools to discover subdomains and files, and checks for virtual
hosts and databases on a given target URL or IP address.

Usage: python3 subdomain_file_enumerator.py
"""

import argparse
import subprocess
import sys

# Prompt user for target URL or IP address
target = input("Enter the target URL or IP address: ").strip()

try:
    # Run ffuf with directory scan and print results to console
    ffuf_result = subprocess.run(
        ["ffuf", "-w", "/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt", "-u", f"{target}/FUZZ",
         "-e", ".html,.php,.asp,.aspx,.jsp,.htm,.js", "-mc", "200,204,301,302,307,401,403"],
        capture_output=True, text=True, check=True)
    print(ffuf_result.stdout)

    # Run gobuster on ffuf results to discover subdomains and print results to console
    gobuster_result = subprocess.run(["gobuster", "vhost", "-w", "-", "-u", target],
                                     input=ffuf_result.stdout, capture_output=True, text=True, check=True)
    print(gobuster_result.stdout)

    # Use gobuster results to find files and directories and print results to console
    file_fuzz_result = subprocess.run(
        ["ffuf", "-w", "/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt",
         "-w", "/usr/share/wordlists/dirbuster/directory-list-2.3-small.txt",
         "-w", "/usr/share/wordlists/dirbuster/directory-list-2.3-big.txt",
         "-w", "/usr/share/wordlists/SecLists/Discovery/Web-Content/raft-medium-directories-lowercase.txt",
         "-w", "/usr/share/wordlists/SecLists/Discovery/Web-Content/raft-large-directories-lowercase.txt",
         "-w", "/usr/share/wordlists/SecLists/Discovery/Web-Content/raft-medium-files-lowercase.txt",
         "-w", "/usr/share/wordlists/SecLists/Discovery/Web-Content/raft-large-files-lowercase.txt",
         "-w", "/usr/share/wordlists/SecLists/Discovery/Web-Content/common.txt", "-w", "-",
         "-u", f"{target}/FUZZ", "-e", ".html,.php,.asp,.aspx,.jsp,.htm,.js", "-mc", "200,204,301,302,307,401,403"],
        input=gobuster_result.stdout, capture_output=True, text=True, check=True)
    print(file_fuzz_result.stdout)

    # Check for virtual hosts and print results to console
    virtual_host_result = subprocess.run(["gobuster", "dns", "-w", "/usr/share/wordlists/subdomains-top1million-5000.txt",
                                          "-d", target], capture_output=True, text=True, check=True)
    print(virtual_host_result.stdout)

    # Check for databases and print results to console
    database_result = subprocess.run(["nmap", "-p", "3306", "--script", "mysql-databases", target],
                                     capture_output=True, text=True, check=True)
    print(database_result.stdout)

except subprocess.CalledProcessError as e:
    print("An error occurred while running the command:", e.cmd, file=sys.stderr)
    print("Output:", e.output.decode(), file
