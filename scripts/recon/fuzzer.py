#!/usr/bin/env python3

"""
This script chains together popular fuzzing and enumeration tools to discover subdomains and files, and checks for virtual
hosts and databases on a given target URL or IP address.

Usage: python3 subdomain_file_enumerator.py
"""

import argparse
import subprocess
import sys

# Prompt user for target URL or IP address
target = input("Enter the target URL or IP address: ").strip()

print("[*] Running ffuf directory scan...")
try:
    # Run ffuf with directory scan and print results to console
    ffuf_result = subprocess.run(
        ["ffuf", "-w", "/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt", "-u", f"{target}/FUZZ",
         "-e", ".html,.php,.asp,.aspx,.jsp,.htm,.js", "-mc", "200,204,301,302,307,401,403"],
        capture_output=True, text=True, check=True)
    print(ffuf_result.stdout)

    print("[*] Running gobuster dir scan...")
    # Run gobuster on ffuf results to discover subdomains and print results to console
    gobuster_result = subprocess.run(["gobuster", "dir", "-w", "/usr/share/wordlists/dirb/common.txt", "-u", target, "--wildcard"],
                                     capture_output=True, text=True, check=True)
    print(gobuster_result.stdout)

    # Use gobuster results to find files and directories and print results to console
    print("[*] Running ffuf file scan...")
    file_fuzz_result = subprocess.run(
        ["ffuf", "-w", "/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt",
         "-u", f"{target}/FUZZ", "-e", ".html,.php,.asp,.aspx,.jsp,.htm,.js",
         "-mc", "200,204,301,302,307,401,403"],
        input=gobuster_result.stdout, capture_output=True, text=True, check=True)
    print(file_fuzz_result.stdout)

    # Check for virtual hosts and print results to console
    print("[*] Running gobuster dns scan...")
    virtual_host_result = subprocess.run(["gobuster", "dns", "-w", "/usr/share/wordlists/subdomains-top1million-5000.txt", "-d", target], capture_output=True, text=True, check=True)
    print(virtual_host_result.stdout)

    # Check for databases and print results to console
    print("[*] Running nmap scan...")
    database_result = subprocess.run(["nmap", "-p", "3306", "--script", "mysql-databases", target],
                                     capture_output=True, text=True, check=True)
    print(database_result.stdout)

except subprocess.CalledProcessError as e:
    print("An error occurred while running the command:", e.cmd, file=sys.stderr)
    print("Output:", e.output, file=sys.stderr)
