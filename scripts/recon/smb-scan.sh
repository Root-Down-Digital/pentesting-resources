#!/bin/bash

# Script to check for signs of hacking and malware on a system

# Get interface
interface=$(ip addr show | grep -E '^[0-9]:' | awk '{print $2}' | tr -d :)

# Get local broadcast IP 
broadcast_ip=$(ifconfig $interface | grep -E 'inet[^6]' | grep -oE 'broadcast [0-9.]+' | awk '{print $2}')

# Create a log file with a timestamp
log_file="scan_$(date +%Y-%m-%d_%H-%M-%S).txt"
touch $log_file

# Check for unauthorized SSH access
echo "Checking for unauthorized SSH access..." | tee -a $log_file
ssh_connections=$(lsof -i :22)
unauthorized_connections=$(echo "$ssh_connections" | grep -v "root" | grep -v "authorized_user")

if [ -n "$unauthorized_connections" ]; then
    echo "Unauthorized SSH connections detected:" | tee -a $log_file
    echo "$unauthorized_connections" | tee -a $log_file
else
    echo "No unauthorized SSH connections detected." | tee -a $log_file
fi

# Check for open SMB ports
echo "Checking for open SMB ports..." | tee -a $log_file
open_ports=$(netstat -an | grep ":445\|:139")

if [ -n "$open_ports" ]; then
    echo "Open SMB ports detected:" | tee -a $log_file
    echo "$open_ports" | tee -a $log_file
else
    echo "No open SMB ports detected." | tee -a $log_file
fi

#Check for SMB shares
echo "Checking for SMB shares..." | tee -a $log_file
smb_shares=$(smbclient -L $broadcast_ip)

if [ -n "$smb_shares" ]; then
    echo "SMB shares detected:" | tee -a $log_file
    echo "$smb_shares" | tee -a $log_file
else
    echo "No SMB shares detected." | tee -a $log_file
fi

# Check for SMB vulnerabilities
echo "Checking for SMB vulnerabilities..." | tee -a $log_file
smb_vulnerabilities=$(nmap --script smb-vuln* -p 445 $broadcast_ip)

if [ -n "$smb_vulnerabilities" ]; then
    echo "SMB vulnerabilities detected:" | tee -a $log_file
    echo "$smb_vulnerabilities" | tee -a $log_file
else
    echo "No SMB vulnerabilities detected." | tee -a $log_file
fi

echo "Scan complete. Results saved in $log_file" | tee -a $log_file
